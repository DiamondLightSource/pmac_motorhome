CLOSE

;####################################################
; Autogenerated Homing PLC for GeoBrick, DO NOT MODIFY
{%- for group_num in range(plc.count) %}
; Group {{ group_num }}
{{ plc.groups[group_num].comments }}
{%- endfor %}
;####################################################

; Use a different timer for each PLC
#define timer             i(5111+({{plc.plc_num}}&30)*50+{{plc.plc_num}}%2)
; Make timer more readable
#define MilliSeconds      * 8388608/i10

; Homing State P Variable
#define HomingState       P1100
#define StateIdle         0
#define StateConfiguring  1
#define StateMoveNeg      2
#define StateMovePos      3
#define StateHoming       4
#define StatePostHomeMove 5
#define StateAligning     6
#define StateDone         7
#define StateFastSearch   8
#define StateFastRetrace  9
#define StatePreHomeMove  10
HomingState = StateIdle

; Homing Status P Variable
#define HomingStatus      P1101
#define StatusDone        0
#define StatusHoming      1
#define StatusAborted     2
#define StatusTimeout     3
#define StatusFFErr       4
#define StatusLimit       5
#define StatusIncomplete  6
#define StatusInvalid     7
#define StatusPaused      8
#define StatusDebugHoming 9
HomingStatus = StatusDone

; Homing Group P Variable
#define HomingGroup       P1102
HomingGroup = 0

; Homing Group Backup P Variable
#define HomingBackupGroup P1103
HomingBackupGroup = 0

OPEN PLC{{plc.plc_num}} CLEAR

if (HomingStatus != StatusHoming)
and (HomingStatus != StatusDebugHoming)
    HomingStatus = StatusHoming
endif

{%- include 'configure_state.pmc.jinja' %}

{% for group in plc.groups %}
if (HomingBackupGroup = 1 or HomingBackupGroup = {{ group.group_num }})
and (HomingStatus = StatusHoming or HomingStatus = StatusDebugHoming)
    HomingGroup={{ group.group_num }}

    {% include 'pre_home_move.pmc.jinja' %}

endif
{% endfor %}

;---- Done ----
if (HomingStatus = StatusHoming or HomingStatus = StatusDebugHoming)
    ;If we've got this far without failing, set status and state done
    HomingStatus=StatusDone
    HomingState=StateDone
    ;Restore the homing group from px03
    HomingGroup=HomingBackupGroup
endif

;---- Tidy Up ----
; TODO TODO TODO


DISABLE PLC{{plc.plc_num}}
CLOSE
